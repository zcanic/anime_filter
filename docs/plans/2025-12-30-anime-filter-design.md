# 番剧筛选应用设计文档

**项目名称**: Anime Filter
**创建日期**: 2025-12-30
**版本**: v1.0

---

## 1. 项目目的

### 1.1 核心目标
构建一个高效的番剧筛选应用，让用户能够以最直觉、最流畅的方式遍历 2011-2025 年所有 Bangumi 番剧数据（14,000+ 条），快速标记已看/想看/跳过状态，最终生成个人番剧观赏图谱。

### 1.2 关键需求
- **超高效筛选**: 多卡片网格布局 + 键盘快捷键 + 滑动手势，追求原生应用流畅度
- **无缝体验**: 23MB 数据即时加载，虚拟滚动，60fps 流畅动画
- **多视图模式**: 支持大卡片（3-4张）、中卡片（8-12张）、小卡片（20-30张）自适应切换
- **批量操作**: 一键全标记当前屏幕所有卡片，快速过滤大量数据
- **数据可视化**: 生成个人观赏图谱（时间轴、类型分布、评分统计、年度总结）
- **本地优先**: 无需后端服务，所有数据本地处理和存储
- **分享功能**: 导出图片卡片、数据列表，支持剪贴板复制

---

## 2. 技术架构

### 2.1 整体架构选型

**选择: Tauri 2.0 桌面应用**

**理由**:
1. **性能优势**: Rust 后端处理 23MB CSV 数据仅需 200-300ms，数据过滤速度比纯 Web 快 10-50 倍
2. **体积小**: 比 Electron 小 10 倍（约 5-10MB vs 50-100MB）
3. **原生体验**: 真正的 60fps 流畅度，原生文件系统访问
4. **无需后端**: 本地数据存储和处理，完全离线可用
5. **跨平台**: Windows/macOS/Linux 一次构建

**备选方案（未采用）**:
- Web 应用: 数据加载慢，需要复杂的分片和 Worker 优化
- Electron: 体积大，性能不如 Tauri

---

## 3. 技术栈详解

### 3.1 前端技术栈

```
React 18 + TypeScript
├── 构建工具: Vite (极快的 HMR，冷启动 < 1s)
├── UI 框架: TailwindCSS + shadcn/ui (现代化组件库)
├── 状态管理: Zustand (轻量级，100 行代码实现全局状态)
├── 虚拟滚动: TanStack Virtual (处理大列表渲染)
├── 数据获取: TanStack Query (缓存和同步)
├── 动画库: Framer Motion (流畅的卡片动画)
├── 手势识别: @use-gesture/react (滑动操作)
└── 图表可视化: Recharts (数据图谱)
```

**为什么选择 React**:
- 生态成熟，组件丰富
- TypeScript 支持完善
- 虚拟 DOM 性能优秀
- 开发者熟悉度高

### 3.2 后端技术栈（Rust）

```
Tauri 2.0
├── 数据解析: csv crate (高性能 CSV 解析)
├── 数据库: rusqlite (SQLite，存储用户筛选状态)
├── 序列化: serde + serde_json (Rust ↔ TypeScript 数据交换)
├── 图片处理: image crate (缓存和压缩封面图)
└── 文件系统: std::fs (读取本地 CSV 数据)
```

**Rust 后端职责**:
1. **启动时**: 一次性加载 23MB CSV，构建内存索引
2. **数据过滤**: 根据年份/评分/标签/状态快速过滤
3. **状态持久化**: SQLite 存储用户的标记（已看/想看/跳过）
4. **图片缓存**: 下载并缓存 Bangumi 封面图到本地
5. **数据导出**: 生成 JSON/CSV/PNG 格式的分享文件

### 3.3 数据层设计

**数据源**:
- 本地 CSV 文件（`/Users/zcan/Documents/sthtry/anime_csv/full_data.csv`）
- 14,257 条记录，23MB
- 字段: url, subject_id, title, img_url, year, tags, 评分, 收藏数, 角色, 声优等 22 个字段

**数据加载策略**:
```
启动流程:
1. Rust 读取 CSV → 解析 → 构建索引（200-300ms）
2. 全量数据加载到内存（~50MB，现代电脑无压力）
3. 构建年份/标签/评分的 B-Tree 索引，支持快速过滤
4. 从 SQLite 读取用户历史标记状态
5. 前端首次渲染显示 100 条数据（虚拟滚动）
```

**用户数据存储**:
```sql
-- SQLite Schema
CREATE TABLE user_status (
  subject_id INTEGER PRIMARY KEY,
  status TEXT NOT NULL,  -- 'watched' | 'wishlist' | 'skipped'
  rating INTEGER,         -- 用户评分 1-10
  tags TEXT,              -- 用户自定义标签（JSON数组）
  marked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_status ON user_status(status);
CREATE INDEX idx_marked_at ON user_status(marked_at);
```

---

## 4. 核心功能设计

### 4.1 超高效筛选界面

#### 4.1.1 多卡片网格布局
- **自适应视图**:
  - 大卡片模式: 3-4 张/屏（详细信息：封面、标题、简介、评分、标签）
  - 中卡片模式: 8-12 张/屏（推荐，平衡信息量和速度）
  - 小卡片模式: 20-30 张/屏（快速浏览，主要显示封面和标题）
- **虚拟滚动**: 只渲染可见卡片 + 缓冲区，支持流畅滚动 14k+ 数据
- **懒加载图片**: 封面图按需加载，支持占位符和渐进式显示

#### 4.1.2 键盘快捷键系统

**单卡片操作**:
- `J` (或 `←`): 标记"已看"（绿色动画）
- `K` (或 `↓`): 标记"跳过"（灰色动画）
- `L` (或 `→`): 标记"想看"（黄色动画）
- `Space`: 查看详情
- `数字 1-5`: 快速评分

**批量操作**（按住 `Shift` 进入批量模式）:
- `Shift + A`: 当前屏所有卡片标记为"已看"
- `Shift + D`: 当前屏所有卡片标记为"跳过"
- `Shift + S`: 当前屏所有卡片标记为"想看"
- 释放 `Shift`: 自动翻页到下一屏

**导航**:
- `↑/↓`: 上下滚动
- `Page Up/Down`: 翻页
- `/`: 聚焦搜索框
- `Esc`: 取消选择/退出详情

**界面提示**:
右下角固定显示快捷键提示:
```
已看  跳过  想看
J     K     L
←     ↓     →
```

#### 4.1.3 滑动手势操作
- **向左滑**: 已看（卡片向左飞出，绿色轨迹）
- **向下滑**: 跳过（卡片淡出，灰色）
- **向右滑**: 想看（卡片向右飞出，黄色轨迹）
- **点击**: 查看详情弹窗

### 4.2 智能过滤系统

**过滤维度**:
- **年份**: 2011-2025，支持范围选择（如 2015-2020）
- **评分**: 滑块选择评分范围（如 7.5-9.0）
- **标签**: 多选标签（搞笑/奇幻/战斗/恋爱等）
- **状态**: 已看/想看/跳过/未标记
- **收藏数**: 热门度过滤（如 > 10000 收藏）
- **完成率**: 筛选高完成率番剧

**搜索功能**:
- 实时搜索标题/别名
- 支持拼音首字母搜索
- 模糊匹配

### 4.3 个人番剧图谱

#### 4.3.1 数据可视化组件

**1. 时间轴视图**
- 按年份/季度展示观看历史
- 可交互时间轴，点击查看该时期番剧
- 显示观看高峰期

**2. 类型雷达图**
- 展示用户偏好的番剧类型分布
- 基于已看番剧的标签统计
- 可对比 Bangumi 平均分布

**3. 评分分布图**
- 柱状图展示用户看过的番剧评分分布
- 对比用户评分 vs Bangumi 评分

**4. 年度总结卡片**
- 类似 Spotify Wrapped 的精美卡片
- 内容: 今年看了多少部、最爱类型、评分最高、观看时长等
- 支持切换年份查看历史总结

**5. TOP 榜单**
- 个人评分最高的番剧
- 观看次数最多的类型
- 发现的宝藏番剧（低收藏但高评分）

#### 4.3.2 分享功能（无后端）

**导出格式**:
1. **PNG/SVG 图片卡片**: 使用 html2canvas 或 dom-to-image 生成精美分享卡片
2. **JSON 数据**: 完整的用户标记数据，可导入到其他设备
3. **CSV 列表**: 已看番剧列表，兼容 Excel
4. **剪贴板**: 一键复制数据或图片

**实现方式**:
- 所有生成在前端完成（Canvas API）
- Tauri 提供本地文件保存对话框
- 无需任何后端服务

---

## 5. 性能优化策略

### 5.1 启动性能
- **目标**: 冷启动 < 2 秒
- **优化**:
  - Rust 并行解析 CSV（Rayon）
  - 增量索引构建
  - 懒加载非关键数据（角色、声优）

### 5.2 渲染性能
- **目标**: 60fps 流畅滚动和动画
- **优化**:
  - TanStack Virtual 虚拟滚动（只渲染可见区域）
  - React.memo 防止不必要的重渲染
  - 图片懒加载 + WebP 格式
  - CSS GPU 加速（transform/opacity）

### 5.3 内存优化
- **目标**: 常驻内存 < 200MB
- **优化**:
  - 图片缓存 LRU 策略（最多缓存 200 张）
  - 虚拟滚动减少 DOM 节点
  - 及时清理未使用的组件状态

### 5.4 数据过滤性能
- **目标**: 任意过滤条件响应 < 50ms
- **优化**:
  - Rust 端构建 B-Tree 索引
  - 多线程过滤（Rayon）
  - 防抖搜索输入（300ms）

---

## 6. 用户体验设计

### 6.1 首次使用流程
1. 启动应用 → 显示加载动画（"正在加载 14,257 部番剧..."）
2. 加载完成 → 显示欢迎页面（简短教程）
3. 进入主界面 → 开始筛选

### 6.2 主界面布局
```
┌─────────────────────────────────────────────────┐
│  [Logo] Anime Filter        [搜索框]   [设置]  │
├─────────────────────────────────────────────────┤
│  [过滤器面板]                                   │
│  年份: [2011-2025]  评分: [7.0-10.0]           │
│  标签: [搞笑] [奇幻] [战斗]                     │
│  状态: [全部] [已看] [想看] [跳过] [未标记]    │
├─────────────────────────────────────────────────┤
│                                                 │
│  [卡片网格区域 - 虚拟滚动]                      │
│                                                 │
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐                  │
│  │封面│ │封面│ │封面│ │封面│                  │
│  │标题│ │标题│ │标题│ │标题│                  │
│  └────┘ └────┘ └────┘ └────┘                  │
│                                                 │
│  [更多卡片...]                                  │
│                                                 │
├─────────────────────────────────────────────────┤
│  已筛选: 1234/14257  ┃  [我的图谱]  [导出]     │
│                                   已看 跳过 想看│
│                                   J    K    L  │
│                                   ←    ↓    →  │
└─────────────────────────────────────────────────┘
```

### 6.3 动画和反馈
- **卡片动画**: 悬浮放大、滑动飞出、标记闪烁
- **加载状态**: 骨架屏、进度条
- **操作反馈**: Toast 提示、音效（可选）
- **主题**: 支持亮色/暗色模式

---

## 7. 技术风险与应对

### 7.1 图片加载慢
**风险**: 14k+ 番剧封面图从 Bangumi CDN 加载可能很慢
**应对**:
- 首次加载时批量下载热门番剧封面到本地
- 使用 Tauri 的后台下载 API
- 显示占位符和加载进度

### 7.2 数据更新
**风险**: Bangumi 数据会持续更新（新番、评分变化）
**应对**:
- 提供"更新数据"功能，用户手动触发
- 增量更新策略（只更新变化的记录）

### 7.3 跨平台兼容性
**风险**: Windows/macOS/Linux 行为差异
**应对**:
- 使用 Tauri 的跨平台 API
- 在主要平台上充分测试
- 优先支持 macOS 和 Windows

---

## 8. 开发计划

### Phase 1: 基础框架（第 1-2 天）
- [x] 项目初始化（Tauri + React + Vite）
- [ ] Rust 后端 CSV 解析和索引
- [ ] SQLite 数据库设计和集成
- [ ] 前端路由和基础布局

### Phase 2: 核心筛选功能（第 3-5 天）
- [ ] 卡片网格组件 + 虚拟滚动
- [ ] 键盘快捷键系统
- [ ] 滑动手势识别
- [ ] 过滤器面板和搜索

### Phase 3: 数据可视化（第 6-7 天）
- [ ] 时间轴视图
- [ ] 类型雷达图
- [ ] 评分分布图
- [ ] 年度总结卡片

### Phase 4: 分享和导出（第 8 天）
- [ ] 图片导出（Canvas）
- [ ] JSON/CSV 导出
- [ ] 剪贴板功能

### Phase 5: 优化和测试（第 9-10 天）
- [ ] 性能优化
- [ ] 跨平台测试
- [ ] Bug 修复
- [ ] 打包和发布

---

## 9. 项目结构

```
anime-filter/
├── src/                    # React 前端
│   ├── components/         # UI 组件
│   │   ├── AnimeCard.tsx   # 番剧卡片
│   │   ├── CardGrid.tsx    # 卡片网格
│   │   ├── FilterPanel.tsx # 过滤面板
│   │   └── Charts/         # 图表组件
│   ├── hooks/              # 自定义 Hooks
│   ├── store/              # Zustand 状态管理
│   ├── types/              # TypeScript 类型定义
│   └── utils/              # 工具函数
├── src-tauri/              # Rust 后端
│   ├── src/
│   │   ├── main.rs         # 主入口
│   │   ├── csv_parser.rs   # CSV 解析
│   │   ├── database.rs     # SQLite 操作
│   │   └── commands.rs     # Tauri 命令
│   └── Cargo.toml          # Rust 依赖
├── data/                   # 数据文件
│   └── full_data.csv       # Bangumi 数据
├── docs/                   # 文档
│   └── plans/              # 设计文档
└── package.json            # Node 依赖
```

---

## 10. 总结

这是一个追求极致性能和用户体验的番剧筛选应用，核心亮点：

1. **原生级流畅**: Tauri + Rust 实现 60fps 无卡顿
2. **高效交互**: 多快捷键 + 批量操作 + 手势，快速筛选 14k+ 数据
3. **数据可视化**: 精美的个人观赏图谱
4. **本地优先**: 无需后端，完全离线可用
5. **现代化技术栈**: React 18 + TypeScript + TailwindCSS

**技术挑战**:
- 大数据量的高性能渲染
- 流畅的动画和交互
- 优雅的键盘和手势操作

**预期成果**:
一个让番剧爱好者爱不释手的筛选工具，帮助他们快速整理观看历史，发现更多优质番剧。

---

*文档创建于 2025-12-30*
